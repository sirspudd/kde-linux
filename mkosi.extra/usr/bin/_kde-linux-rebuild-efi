#!/bin/bash
# SPDX-License-Identifier: GPL-2.0-only OR GPL-3.0-only OR LicenseRef-KDE-Accepted-GPL
# SPDX-FileCopyrightText: 2023-2025 Harald Sitter <sitter@kde.org>

set -ex

. /etc/os-release

kernel_version="$1"
if [ -z "$kernel_version" ]; then
  versions=(/usr/lib/modules/*)
  version="${versions[-1]}"
  kernel_version="$(basename "$version")"
fi

if [ -z "$kernel_version" ]; then
  echo "No kernel version specified/found"
  exit 1
fi

# NOTE: plymouth MUST be after systemd as per the wiki!
cat <<- EOF > mkinitcpio.conf
MODULES=(overlay)
BINARIES=()
FILES=()
HOOKS=(base systemd modconf kms keyboard block sd-encrypt filesystems fsck systemd-extension plymouth microcode)
EOF

echo "rw \
  systemd.volatile=overlay systemd.firstboot=false systemd.hostname=kde-linux kde-linux.live=1 plasma.live.user=live \
  lsm=landlock,lockdown,yama,integrity,apparmor,bpf \
  zswap.enabled=0 \
  preempt=full threadirqs \
  nohz=on nohz_full=all \
  rcu_nocbs=all rcutree.enable_rcu_lazy=1 \
  vt.global_cursor_default=0 quiet splash loglevel=3" > cmdline
mkinitcpio --config mkinitcpio.conf --generate initrd --kernel "$kernel_version"
ukify build \
  --linux /usr/lib/modules/$kernel_version/vmlinuz \
  --initrd initrd \
  --cmdline @cmdline \
  --output live.efi

# lsm= defaulting to apparmor from https://wiki.archlinux.org/title/AppArmor

# "preempt=full threadirqs" reduces latency especially for audio and gaming workflows.

# "nohz=on nohz_full=all" stops waking up a CPU more than once a second if it has fewer
# than 2 tasks. This reduces latency for userspace software and may also save power. The
# kernel requires at least one CPU to not be using this mode, but it will choose one for
# us. This requires nohz=on, which is the default, but we manually specify it here anyway
# because nohz_full=all needs it and we don't want that to break.

# "rcu_nocbs=all rcutree.enable_rcu_lazy=1" turns on batched/lazy RCU on all CPUs,
# reducing wake-ups and therefore power usage. rcu_nocbs=all is actually turned on
# automatically by nohz_full=all, but we manually specify it here anyway because
# rcutree.enable_rcu_lazy=1 needs it and we don't want that to break.
echo "rw rootflags=subvol=@system,compress=zstd:1 \
  lsm=landlock,lockdown,yama,integrity,apparmor,bpf \
  zswap.enabled=0 \
  preempt=full threadirqs \
  nohz=on nohz_full=all \
  rcu_nocbs=all rcutree.enable_rcu_lazy=1 \
  default_hugepagesz=2M hugepagesz=2M transparent_hugepage=madvise kernelcore=25% mitigations=off \
  vt.global_cursor_default=0 quiet splash loglevel=3" > cmdline
mkinitcpio --config mkinitcpio.conf --generate initrd --kernel "$kernel_version"
ukify build \
  --linux /usr/lib/modules/$kernel_version/vmlinuz \
  --initrd initrd \
  --cmdline @cmdline \
  --output kde-linux.efi

# Mock artifact for upgrades, see build.sh
ukify build \
  --cmdline "kde-linux.erofs.silence" \
  --output erofs.addon.efi
