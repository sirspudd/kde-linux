#!/bin/sh
# SPDX-License-Identifier: GPL-2.0-only OR GPL-3.0-only OR LicenseRef-KDE-Accepted-GPL
# SPDX-FileCopyrightText: 2025 Nate Graham <nate@kde.org>

# Set up the rudiments of a development environment for developing KDE software
# that's shipped on the KDE Linux OS image

set -e

CONFIG_FILE_SOURCE=/usr/share/factory/etc/xdg/kde-builder.yaml
CONFIG_FILE_DESTINATION=~/.config/kde-builder.yaml
DID_SOMETHING=false

SYSEXT_OUTPUT="$(_kde-linux-set-up-systemd-extension)"
echo "${SYSEXT_OUTPUT}"
if [[ "${SYSEXT_OUTPUT}" =~ "Finished setting up extension" ]]; then
    DID_SOMETHING=true
fi

echo
if [ -f "${HOME}/.local/bin/kde-builder" ]; then
    echo "== kde-builder build tool: already installed, skipping =="
else
    echo "== kde-builder build tool: needs setup =="
    echo 'Downloading and installing...'
    curl 'https://invent.kde.org/sdk/kde-builder/-/raw/master/scripts/initial_setup.sh' > /tmp/initial_setup.sh
    bash /tmp/initial_setup.sh
    DID_SOMETHING=true
fi

echo
if [ -f "${HOME}/.config/kde-builder.yaml" ]; then
    echo "== kde-builder config file: already present, skipping =="
else
    echo "== kde-builder config file: needs setup =="
    echo "Copying ${CONFIG_FILE_SOURCE} to  ${CONFIG_FILE_DESTINATION}..."
    cp "${CONFIG_FILE_SOURCE}" "${CONFIG_FILE_DESTINATION}"
    DID_SOMETHING=true
fi

echo
if [ "${DID_SOMETHING}" = "true" ]; then
    echo "== Done! =="
    echo "See https://community.kde.org/KDE_Linux/Develop_KDE_software#Use to learn what to do next."
    echo "See https://community.kde.org/Get_Involved/development to learn about KDE development in general."
else
    echo "== Nothing to do! =="
    echo "Development environment already appears to be set up properly."
fi
